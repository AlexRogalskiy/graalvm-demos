# GraalVM Demos: Native jshell and Espresso

This demo showcases the integration between [GraalVM Native Image](https://www.graalvm.org/reference-manual/native-image/) and [Java-on-Truffle (Espresso)](https://www.graalvm.org/reference-manual/java-on-truffle/).  
It builds a native image of `jshell`, that executes the dynamically generated bytecodes on Espresso. This hybrid mode achieves instant startup, beating the vanilla `jshell` in both: time to the first interaction and time to evaluate a simple expression.

JShell is a Java read-eval-print loop tool first introduced in Java 9, this demo also allows to run `jshell` on Java 8.

## Prerequisites

- GraalVM for Java 11, 17 or higher
- Native Image support
- Java-on-Truffle (Espresso) support

Download the latest GraalVM [here](https://www.graalvm.org/downloads/).  
Having [GraalVM installed](https://www.graalvm.org/docs/getting-started/#install-graalvm), install the _Native Image_ and _Java on Truffle_ (Espresso) components.  
GraalVM bundles [`gu`](https://www.graalvm.org/reference-manual/graalvm-updater/), a command line utility to install and manage additional functionalities/components; to install the _Native Image_ and _Java on Truffle_ (Espresso) components, run the following command:

```bash
<graalvm>/bin/gu install native-image espresso
```

## How to Build
Set the `GRAALVM_HOME` environment variable to the GraalVM home:
```bash
export GRAALVM_HOME="/path/to/graalvm"
```

Then execute the `build-espresso-jshell.sh` script:
```bash
./build-espresso-jshell.sh
```

It generates a native executable: `espresso-jshell` in the working directory.
This native executable, `espresso-jshell [options...]`, runs with almost-instant startup.

Launch `./espresso-jshell -Dorg.graalvm.home="$GRAALVM_HOME"`, execute some Java code and see the output immediately.
To exit the shell, type `/exit`.

## Running `jshell` on Java 8

`jshell` was first introduced in Java 9, but thanks to Java's excellent backwards compatibility, it's possible to run `jshell` on a Java 8 environment.

```bash
export GRAALVM_HOME="/path/to/graalvm"
export JDK8_HOME="/path/to/jdk8"
./jshell8.sh [options...]
```

It may seem that `espresso-jshell` is running Java 11 in this mode, and it is.  
`jshell` (the frontend) is compiled by native-image with Java 11 (or 17), but the Java compiler (`javac` has a Java API used by `jshell`) is fully backwards compatible with Java 8 e.g. `javac -source 8 -target 8 -bootclasspath JAVA8_BOOT_CLASSPATH`.  
The generated bytecodes are then executed in Espresso (the backend) which runs a Java 8 guest JVM.

You can run the following snippet to convince yourself that it indeed, runs on Java 8:
```java
System.getProperty("java.vm.version");

// `jshell -C-source -C8` forbids getModule() access from code,
// but it is still accessible through reflection.
Object.class.getModule();

// In true Java 8 mode, getModule() is not accessible at all,
// not even through reflection.
Class.class.getDeclaredMethod("getModule");
```

Pass system properties to Espresso with `-R-Dkey=value`.  
Pass polyglot options to Espresso with `-Rjava.InlineFieldAccessors -Rengine.Compilation=false`.

## Details
`espresso-jshell` behaves similar to `jshell -execution local` and should not be directly compared with the default `jshell` execution engine, e.g. class redefinition is not supported (`jshell -execution local` does not support it either).
It does not  support execution engines other than `-execution espresso`. 

Note that `espresso-jshell` is not fully standalone, it doesn't bundle _jars/jmods_ nor the core Java native libraries. `jshell` also needs a proper `java.home` for `javac` to be able to compile Java code.
Specifying a GraalVM home is the easiest way for Espresso and `jshell` to find all these dependencies e.g. `./espresso-jshell -Dorg.graalvm.home="$GRAALVM_HOME"`.
